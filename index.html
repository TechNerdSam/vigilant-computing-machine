<!DOCTYPE html>
<html lang="fr" class="theme-warm">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Coran - Oasis de Sérénité</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&family=Inter:wght@400;500;600;700&family=Lora:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-sans: 'Inter', sans-serif; --font-serif: 'Lora', serif; --font-quran: 'Amiri Quran', serif;
        }
        html.theme-warm {
            --bg-deep: #281E19; --bg-base: #41312A; --bg-surface: #5B453D;
            --text-main: #F4E9E2; --text-muted: #BCAEA8; --primary: #E58D52; --accent: #FFC96F;
        }
        html.theme-dark {
            --bg-deep: #0D1A26; --bg-base: #172A3A; --bg-surface: #2C3E50;
            --text-main: #E0E7FF; --text-muted: #8A9BB3; --primary: #38BDF8; --accent: #F59E0B;
        }
        html.theme-light {
            --bg-deep: #FDFBFA; --bg-base: #FFFFFF; --bg-surface: #F5F3F1;
            --text-main: #41312A; --text-muted: #7A6961; --primary: #D16B2A; --accent: #E58D52;
        }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-sans); background-color: var(--bg-deep); color: var(--text-main); }
        .font-quran { font-family: var(--font-quran); line-height: 2.5 !important; }
        .sidebar, .context-panel { background-color: var(--bg-deep); transition: transform 0.3s ease-in-out; }
        .main-content { background-color: var(--bg-base); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--bg-surface); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
        .ayah.active { background-color: rgba(229, 141, 82, 0.1); border-right-color: var(--primary); }
        html.theme-dark .ayah.active { background-color: rgba(56, 189, 248, 0.1); border-right-color: var(--primary); }
        html.theme-light .ayah.active { background-color: rgba(209, 107, 42, 0.1); border-right-color: var(--primary); }
        .glowing-divider { height: 1px; background: linear-gradient(90deg, transparent, var(--primary), transparent); opacity: 0.5; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltip-text { visibility: hidden; background-color: var(--bg-deep); color: var(--text-main); text-align: center; border-radius: 6px; padding: 5px 10px; position: absolute; z-index: 50; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; white-space: nowrap; }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        .modal { backdrop-filter: blur(8px); }
        .zen-mode #sidebar, .zen-mode #context-panel, .zen-mode header, .zen-mode footer { display: none !important; }
        .zen-mode main { height: 100vh; }
        #audio-progress-bar { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; width: 100%;}
        #audio-progress-bar::-webkit-slider-runnable-track { background: var(--bg-surface); height: 4px; border-radius: 2px; }
        #audio-progress-bar::-webkit-slider-thumb { -webkit-appearance: none; margin-top: -6px; height: 16px; width: 16px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 5px var(--primary); }
        .prose { color: var(--text-muted); } .prose strong { color: var(--text-main); }
    </style>
</head>
<body class="overflow-hidden">

    <div id="app-container" class="flex h-screen w-screen text-sm md:text-base">
        <!-- BARRE LATÉRALE -->
        <aside id="sidebar" class="sidebar w-full md:w-80 flex-shrink-0 border-r border-white/10 flex flex-col h-screen absolute md:relative transform -translate-x-full md:translate-x-0 z-40">
            <div class="p-4 border-b border-white/10 flex justify-between items-center"><h1 class="text-2xl font-serif text-white">Le Coran</h1><button id="close-sidebar-btn" class="md:hidden text-text-muted hover:text-white"><i class="fas fa-times fa-lg"></i></button></div>
            <div class="p-2 border-b border-white/10"><div class="flex bg-base rounded-md p-1">
                <button class="nav-tab active w-1/2 p-2 rounded text-sm font-bold" data-tab="surah">Sourates</button>
                <button class="nav-tab w-1/2 p-2 rounded text-sm font-bold" data-tab="juz">Juz</button>
            </div></div>
            <div id="surah-tab" class="tab-content flex flex-col flex-grow"><div class="p-4"><input type="text" id="surah-search" placeholder="Rechercher une sourate..." class="w-full bg-base border border-surface rounded-md py-2 px-4 text-main focus:ring-2 focus:ring-primary focus:outline-none"></div><nav id="surah-list" class="flex-grow overflow-y-auto p-4 space-y-1"></nav></div>
            <div id="juz-tab" class="tab-content hidden flex-grow"><nav id="juz-list" class="flex-grow overflow-y-auto p-4 space-y-1"></nav></div>
            <div class="p-4 border-t border-white/10 flex-shrink-0 space-y-2">
                <button id="bookmarks-btn" class="w-full text-left p-2 rounded-md hover:bg-base flex items-center"><i class="fas fa-bookmark w-6 text-accent"></i> Marque-pages</button>
                <button id="prayer-times-btn" class="w-full text-left p-2 rounded-md hover:bg-base flex items-center"><i class="fas fa-clock w-6 text-primary"></i> Horaires de prière</button>
            </div>
        </aside>

        <!-- CONTENU PRINCIPAL -->
        <main id="main-content" class="main-content flex-1 h-screen flex flex-col overflow-hidden">
            <header class="flex-shrink-0 p-4 border-b border-white/10 flex items-center justify-between z-10 bg-base/80 backdrop-blur-sm">
                <div class="flex items-center"><button id="menu-btn" class="md:hidden text-text-muted hover:text-white mr-4"><i class="fas fa-bars fa-lg"></i></button><div id="surah-header"><h2 class="text-xl font-bold text-white"></h2><p class="text-sm text-text-muted"></p></div></div>
                <div class="flex items-center space-x-2">
                    <button id="play-surah-btn" class="w-10 h-10 rounded-full hover:bg-surface text-text-muted hover:text-white tooltip"><i class="fas fa-play"></i><span class="tooltip-text">Lire la sourate</span></button>
                    <button id="zen-mode-btn" class="w-10 h-10 rounded-full hover:bg-surface text-text-muted hover:text-white tooltip"><i class="fas fa-expand"></i><span class="tooltip-text">Mode Lecture</span></button>
                    <button id="search-btn" class="w-10 h-10 rounded-full hover:bg-surface text-text-muted hover:text-white tooltip"><i class="fas fa-search"></i><span class="tooltip-text">Recherche</span></button>
                    <button id="settings-btn" class="w-10 h-10 rounded-full hover:bg-surface text-text-muted hover:text-white tooltip"><i class="fas fa-cog"></i><span class="tooltip-text">Réglages</span></button>
                    <button id="context-panel-btn" class="text-text-muted hover:text-white lg:hidden"><i class="fas fa-info-circle fa-lg"></i></button>
                </div>
            </header>
            <div id="ayah-container" class="flex-grow overflow-y-auto p-4 md:p-8"></div>
            <footer id="audio-player" class="flex-shrink-0 p-3 border-t border-white/10 bg-deep z-10 space-y-2">
                 <div class="flex items-center justify-center space-x-4">
                    <button id="audio-repeat" class="w-10 h-10 text-xl text-text-muted hover:text-white tooltip"><i class="fas fa-repeat"></i><span class="tooltip-text">Répéter</span></button>
                    <button id="audio-prev" class="w-10 h-10 text-xl text-text-muted hover:text-white"><i class="fas fa-backward-step"></i></button>
                    <button id="audio-play-pause" class="w-14 h-14 text-3xl bg-primary text-bg-deep rounded-full flex items-center justify-center shadow-lg shadow-primary/30"><i class="fas fa-play"></i></button>
                    <button id="audio-next" class="w-10 h-10 text-xl text-text-muted hover:text-white"><i class="fas fa-forward-step"></i></button>
                    <div class="relative tooltip"><button id="playback-speed-btn" class="w-10 h-10 text-sm font-bold text-text-muted hover:text-white">1x</button><span class="tooltip-text">Vitesse</span></div>
                </div>
                <div class="flex items-center space-x-2">
                    <span id="audio-current-time" class="text-xs w-10 text-center">0:00</span>
                    <input type="range" id="audio-progress-bar" value="0" min="0" max="100">
                    <span id="audio-duration" class="text-xs w-10 text-center">0:00</span>
                </div>
            </footer>
        </main>

        <!-- PANNEAU CONTEXTUEL -->
        <aside id="context-panel" class="context-panel w-full lg:w-96 flex-shrink-0 border-l border-white/10 flex flex-col h-screen absolute lg:relative transform translate-x-full lg:translate-x-0 z-30">
            <div class="p-2 border-b border-white/10 flex justify-between items-center">
                <div class="flex bg-base rounded-md p-1">
                    <button class="context-tab active w-1/3 p-2 rounded text-sm font-bold" data-tab="tools">Outils</button>
                    <button class="context-tab w-1/3 p-2 rounded text-sm font-bold" data-tab="tafsir">Tafsir</button>
                    <button class="context-tab w-1/3 p-2 rounded text-sm font-bold" data-tab="notes">Notes</button>
                </div>
                <button id="close-context-panel-btn" class="lg:hidden text-text-muted hover:text-white mr-2"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div id="context-content" class="flex-grow overflow-y-auto p-4"></div>
        </aside>
    </div>
    
    <!-- MODALS -->
    <div id="modal-container" class="fixed inset-0 bg-black/70 modal z-50 hidden items-center justify-center p-4"></div>
    <div id="notification-container" class="fixed top-5 right-5 z-[100] space-y-2"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const state = {
            surahs: [], juzs: [], currentSurahData: null, currentAyah: 1, tafsirData: {},
            lastRead: JSON.parse(localStorage.getItem('lastRead')) || { surah: 1, ayah: 1 },
            bookmarks: JSON.parse(localStorage.getItem('quranBookmarks')) || [],
            notes: JSON.parse(localStorage.getItem('quranNotes')) || {},
            settings: JSON.parse(localStorage.getItem('quranSettings')) || {
                theme: 'theme-warm', fontSize: 18, translation: 'fr.hamidullah', reciter: 'ar.alafasy',
                showTransliteration: false, playbackSpeed: 1, repeat: 'none', hasOnboarded: false
            }
        };

        const dom = {
            app: document.getElementById('app-container'), html: document.documentElement,
            sidebar: document.getElementById('sidebar'), contextPanel: document.getElementById('context-panel'),
            surahList: document.getElementById('surah-list'), juzList: document.getElementById('juz-list'),
            ayahContainer: document.getElementById('ayah-container'),
            surahHeaderH2: document.querySelector('#surah-header h2'), surahHeaderP: document.querySelector('#surah-header p'),
            contextContent: document.getElementById('context-content'), surahSearch: document.getElementById('surah-search'),
            modalContainer: document.getElementById('modal-container'), notificationContainer: document.getElementById('notification-container'),
            audio: new Audio(), audioPlayer: document.getElementById('audio-player'),
            audioPlayPause: document.getElementById('audio-play-pause'), audioPlayPauseIcon: document.querySelector('#audio-play-pause i'),
            audioPrev: document.getElementById('audio-prev'), audioNext: document.getElementById('audio-next'),
            audioRepeat: document.getElementById('audio-repeat'), playbackSpeedBtn: document.getElementById('playback-speed-btn'),
            audioProgressBar: document.getElementById('audio-progress-bar'),
            currentTimeElem: document.getElementById('audio-current-time'), durationElem: document.getElementById('audio-duration'),
            menuBtn: document.getElementById('menu-btn'), closeSidebarBtn: document.getElementById('close-sidebar-btn'),
            contextPanelBtn: document.getElementById('context-panel-btn'), closeContextPanelBtn: document.getElementById('close-context-panel-btn'),
            settingsBtn: document.getElementById('settings-btn'), searchBtn: document.getElementById('search-btn'),
            bookmarksBtn: document.getElementById('bookmarks-btn'), prayerTimesBtn: document.getElementById('prayer-times-btn'),
            zenModeBtn: document.getElementById('zen-mode-btn'),
            playSurahBtn: document.getElementById('play-surah-btn'),
            playSurahBtnIcon: document.querySelector('#play-surah-btn i'),
        };
        
        const QURAN_API_BASE = 'https://api.alquran.cloud/v1';
        const PRAYER_API_BASE = 'https://api.aladhan.com/v1';
        const TAFSIR_API_BASE = 'https://api.qurancdn.com/api/qdc';
        const TRANSLATIONS = { 'fr.hamidullah': 'M. Hamidullah', 'fr.leclerc': 'S. Leclerc' };
        const RECITERS = { 'ar.alafasy': 'Mishary Alafasy', 'ar.abdulbasitmurattal': 'Abdul Basit', 'ar.husary': 'Al-Husary' };
        const PLAYBACK_SPEEDS = [0.75, 1, 1.5, 2];
        const JUZ_START_POINTS = { 1:{s:1,a:1}, 2:{s:2,a:142}, 3:{s:2,a:253}, 4:{s:3,a:93}, 5:{s:4,a:24}, 6:{s:4,a:148}, 7:{s:5,a:82}, 8:{s:6,a:111}, 9:{s:7,a:88}, 10:{s:8,a:41}, 11:{s:9,a:93}, 12:{s:11,a:6}, 13:{s:12,a:53}, 14:{s:15,a:1}, 15:{s:17,a:1}, 16:{s:18,a:75}, 17:{s:21,a:1}, 18:{s:23,a:1}, 19:{s:25,a:21}, 20:{s:27,a:56}, 21:{s:29,a:46}, 22:{s:33,a:31}, 23:{s:36,a:28}, 24:{s:39,a:32}, 25:{s:41,a:47}, 26:{s:46,a:1}, 27:{s:51,a:31}, 28:{s:58,a:1}, 29:{s:67,a:1}, 30:{s:78,a:1} };
        
        // --- Fonctions Utilitaires ---
        const fetchAPI = async (url) => {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            } catch (error) {
                showNotification(`Erreur réseau: Impossible de charger les données.`, 'error');
                console.error("API Error:", error); return null;
            }
        };

        const showNotification = (message, type = 'success') => {
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
            const notif = document.createElement('div');
            notif.className = `p-4 rounded-lg text-white shadow-lg mb-2 ${colors[type]} transform transition-all duration-300 translate-x-full opacity-0`;
            notif.textContent = message;
            dom.notificationContainer.appendChild(notif);
            requestAnimationFrame(() => notif.classList.remove('translate-x-full', 'opacity-0'));
            setTimeout(() => {
                notif.classList.add('translate-x-full', 'opacity-0');
                notif.addEventListener('transitionend', () => notif.remove());
            }, 3000);
        };
        
        const closeModal = () => { dom.modalContainer.innerHTML = ''; dom.modalContainer.classList.add('hidden'); };

        const renderModal = (title, content, footer = '') => {
            dom.modalContainer.innerHTML = `
                <div class="bg-base rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
                    <header class="p-4 border-b border-surface flex justify-between items-center flex-shrink-0"><h2 class="text-xl font-bold">${title}</h2><button class="close-modal-btn text-text-muted hover:text-white text-2xl">&times;</button></header>
                    <div class="p-6 overflow-y-auto flex-grow">${content}</div>
                    ${footer ? `<footer class="p-4 border-t border-surface flex-shrink-0">${footer}</footer>` : ''}
                </div>`;
            dom.modalContainer.classList.remove('hidden');
            const closeBtn = dom.modalContainer.querySelector('.close-modal-btn');
            if (closeBtn) closeBtn.onclick = closeModal;
            dom.modalContainer.onclick = (e) => { if (e.target === dom.modalContainer) closeModal(); };
        };

        const formatTime = (seconds) => {
            if (isNaN(seconds)) return '0:00';
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        };

        const showLoadingState = (element) => { element.innerHTML = `<div class="text-center p-10"><i class="fas fa-spinner fa-spin fa-3x text-primary"></i></div>`; }

        // --- Sauvegarde & Application des Paramètres ---
        const saveSettings = () => localStorage.setItem('quranSettings', JSON.stringify(state.settings));
        const saveLastRead = () => localStorage.setItem('lastRead', JSON.stringify(state.lastRead));
        const saveBookmarks = () => localStorage.setItem('quranBookmarks', JSON.stringify(state.bookmarks));
        const saveNotes = () => localStorage.setItem('quranNotes', JSON.stringify(state.notes));
        
        const applySettings = () => {
            dom.html.className = state.settings.theme;
            dom.ayahContainer.style.fontSize = `${state.settings.fontSize}px`;
            dom.audio.playbackRate = state.settings.playbackSpeed;
            dom.playbackSpeedBtn.textContent = `${state.settings.playbackSpeed}x`;
            updateRepeatIcon();
            if(state.currentSurahData) renderSurah();
        };
        
        const renderOnboardingModal = () => {
             renderModal('Bienvenue dans "Oasis de Sérénité"!', 
                `<div class="space-y-4 text-text-muted">
                    <p>Découvrez une expérience coranique complète et immersive.</p>
                    <ul class="list-disc list-inside space-y-2">
                        <li><strong class="text-main">Explorez :</strong> Naviguez par sourate ou par Juz.</li>
                        <li><strong class="text-main">Écoutez :</strong> Choisissez votre récitateur préféré.</li>
                        <li><strong class="text-main">Étudiez :</strong> Lisez les traductions, le Tafsir et prenez des notes.</li>
                        <li><strong class="text-main">Personnalisez :</strong> Adaptez l'affichage à vos préférences dans les réglages.</li>
                    </ul>
                    <p>Cliquez sur un verset pour commencer.</p>
                </div>`, 
                `<button class="w-full bg-primary text-bg-deep font-bold py-2 px-4 rounded-md close-modal-btn">Commencer l'exploration</button>`
             );
        };

        const updateRepeatIcon = () => {
             const icon = dom.audioRepeat.querySelector('i');
             icon.className = 'fas';
             if (state.settings.repeat === 'ayah') { icon.className = 'fas fa-1'; } 
             else { icon.className = 'fas fa-repeat'; }
             dom.audioRepeat.classList.toggle('text-primary', state.settings.repeat !== 'none');
        };

        const highlightActiveAyah = (ayahNumber) => {
            document.querySelectorAll('.ayah.active').forEach(el => el.classList.remove('active'));
            const ayahElem = document.getElementById(`ayah-${ayahNumber}`);
            if (ayahElem) {
                ayahElem.classList.add('active');
                state.lastRead = { surah: state.currentSurahData.arabic.number, ayah: ayahNumber };
                saveLastRead();
                const rect = ayahElem.getBoundingClientRect();
                const containerRect = dom.ayahContainer.getBoundingClientRect();
                if (rect.top < containerRect.top || rect.bottom > containerRect.bottom) {
                    ayahElem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        };

        // --- Fonctions de Rendu ---
        const renderSurah = () => {
            if (!state.currentSurahData) return;
            const { arabic, transliteration } = state.currentSurahData;
            dom.ayahContainer.innerHTML = arabic.ayahs.map((ayah, i) => `
                <div id="ayah-${ayah.numberInSurah}" class="ayah p-4 border-r-4 border-transparent cursor-pointer" data-ayah-number="${ayah.numberInSurah}">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-sm font-bold text-primary bg-primary/10 px-3 py-1 rounded-full">${arabic.number}:${ayah.numberInSurah}</span>
                    </div>
                    <p class="font-quran text-right text-main pointer-events-none">${ayah.text}</p>
                    ${state.settings.showTransliteration && transliteration.ayahs[i] ? `<p class="text-left text-muted italic mt-4 pointer-events-none">${transliteration.ayahs[i].text}</p>` : ''}
                </div>
            `).join('<div class="glowing-divider my-4"></div>');
        };

        const renderSurahList = (filter = "") => {
             const filtered = state.surahs.filter(s => s.englishName.toLowerCase().includes(filter.toLowerCase()) || s.name.includes(filter) || `${s.number}`.includes(filter));
             dom.surahList.innerHTML = filtered.map(s => `<a href="#" data-surah-number="${s.number}" class="surah-item flex items-center justify-between p-3 rounded-md hover:bg-base transition-all"><div class="flex items-center"><span class="text-xs text-center w-8 h-8 flex items-center justify-center rounded-full bg-base mr-3">${s.number}</span><div><p class="font-bold text-main">${s.englishName}</p><p class="text-xs text-muted">${s.revelationType === 'Meccan' ? 'Mecquoise' : 'Médinoise'} - ${s.numberOfAyahs} versets</p></div></div><p class="font-quran text-xl text-primary">${s.name.replace('سُورَةُ ', '')}</p></a>`).join('');
        };
        
        const renderJuzList = () => {
             dom.juzList.innerHTML = Object.keys(JUZ_START_POINTS).map(juz => `<a href="#" data-juz-number="${juz}" class="juz-item flex items-center p-3 rounded-md hover:bg-base transition-all"><span class="text-xs text-center w-8 h-8 flex items-center justify-center rounded-full bg-base mr-3">${juz}</span><span class="font-bold text-main">Juz ${juz}</span></a>`).join('');
        };

        // --- API & Données ---
        const getSurah = async (surahNumber, isInitialLoad = false) => {
             if (!isInitialLoad) dom.ayahContainer.innerHTML = showLoadingState(dom.ayahContainer);
             state.tafsirData[surahNumber] = null;
             const endpoints = [
                 `${QURAN_API_BASE}/surah/${surahNumber}`, `${QURAN_API_BASE}/surah/${surahNumber}/${state.settings.translation}`,
                 `${QURAN_API_BASE}/surah/${surahNumber}/${state.settings.reciter}`, `${QURAN_API_BASE}/surah/${surahNumber}/en.transliteration`,
             ];
             const [arabicRes, translationRes, audioRes, transliterationRes] = await Promise.all(endpoints.map(fetchAPI));
             if (arabicRes && translationRes && audioRes && transliterationRes) {
                 state.currentSurahData = { arabic: arabicRes.data, translation: translationRes.data, audio: audioRes.data, transliteration: transliterationRes.data };
                 dom.surahHeaderH2.textContent = `${arabicRes.data.number}. ${arabicRes.data.englishName}`;
                 dom.surahHeaderP.textContent = `${arabicRes.data.revelationType === 'Meccan' ? 'Mecquoise' : 'Médinoise'} - ${arabicRes.data.numberOfAyahs} versets`;
                 renderSurah();
                 state.currentAyah = 1;
                 dom.audio.pause();
                 renderContextPanel('tools', false);
             } else {
                 dom.ayahContainer.innerHTML = `<p class="text-center text-red-400">Erreur de chargement de la sourate.</p>`;
             }
        };
        
        const handleAyahClick = async (ayahNumber) => {
            state.currentAyah = ayahNumber;
            highlightActiveAyah(ayahNumber);
            renderContextPanel(document.querySelector('.context-tab.active').dataset.tab, true);
            await playCurrentAyah();
            if (window.innerWidth < 1024 && !dom.contextPanel.classList.contains('translate-x-full')) {
                dom.contextPanel.classList.remove('translate-x-full');
            }
        };

        const renderContextPanel = async (tab = 'tools', fromClick = true) => {
            if (!state.currentSurahData || !state.currentAyah) {
                dom.contextContent.innerHTML = `<div class="text-center text-gray-500 py-16"><i class="fas fa-hand-pointer fa-3x"></i><p class="mt-4">Cliquez sur un verset pour commencer.</p></div>`;
                return;
            }

            const surahNum = state.currentSurahData.arabic.number;
            const ayahNum = state.currentAyah;
            const ayahIndex = ayahNum - 1;

            dom.contextContent.innerHTML = showLoadingState(dom.contextContent);

            switch(tab) {
                case 'tools':
                    const isBookmarked = state.bookmarks.some(b => b.s === surahNum && b.a === ayahNum);
                    dom.contextContent.innerHTML = `
                        <h3 class="font-bold text-lg mb-2 text-main">Verset ${surahNum}:${ayahNum}</h3>
                        <p class="font-quran text-2xl text-right mb-4 text-main">${state.currentSurahData.arabic.ayahs[ayahIndex].text}</p>
                        <p class="mb-4 text-text-muted">${state.currentSurahData.translation.ayahs[ayahIndex].text}</p>
                        <div class="flex space-x-2">
                            <button id="copy-btn" class="flex-1 bg-surface hover:bg-opacity-80 p-2 rounded-md transition-colors"><i class="fas fa-copy mr-2"></i>Copier</button>
                            <button id="bookmark-btn" class="flex-1 ${isBookmarked ? 'bg-accent text-bg-deep' : 'bg-surface'} hover:bg-opacity-80 p-2 rounded-md transition-colors"><i class="fas fa-bookmark mr-2"></i>${isBookmarked ? 'Retirer' : 'Marquer'}</button>
                        </div>`;
                    document.getElementById('copy-btn').onclick = () => {
                        const text = `Coran ${surahNum}:${ayahNum}\n\n${state.currentSurahData.arabic.ayahs[ayahIndex].text}\n\n"${state.currentSurahData.translation.ayahs[ayahIndex].text}"`;
                        navigator.clipboard.writeText(text).then(() => showNotification('Verset copié !'));
                    };
                    document.getElementById('bookmark-btn').onclick = () => {
                        const bookmarkIndex = state.bookmarks.findIndex(b => b.s === surahNum && b.a === ayahNum);
                        if (bookmarkIndex > -1) {
                            state.bookmarks.splice(bookmarkIndex, 1);
                            showNotification('Marque-page retiré.');
                        } else {
                            state.bookmarks.push({ s: surahNum, a: ayahNum, t: state.currentSurahData.arabic.ayahs[ayahIndex].text.substring(0, 40) + '...' });
                            showNotification('Verset marqué !');
                        }
                        saveBookmarks();
                        renderContextPanel('tools', true);
                    };
                    break;
                case 'tafsir':
                    if (!state.tafsirData[surahNum]) {
                        const tafsirRes = await fetchAPI(`${TAFSIR_API_BASE}/tafsirs/1/by_chapter/${surahNum}?per_page=500`);
                        if(tafsirRes) state.tafsirData[surahNum] = tafsirRes.tafsirs;
                        else { dom.contextContent.innerHTML = 'Erreur de chargement du Tafsir.'; return; }
                    }
                    const tafsir = state.tafsirData[surahNum]?.find(t => t.verse_key === `${surahNum}:${ayahNum}`);
                    dom.contextContent.innerHTML = tafsir ? `<div class="prose">${tafsir.text.replace(/<[^>]*>/g, '')}</div>` : 'Tafsir non disponible pour ce verset.';
                    break;
                case 'notes':
                    const noteKey = `${surahNum}:${ayahNum}`;
                    const noteText = state.notes[noteKey] || '';
                    dom.contextContent.innerHTML = `
                        <h3 class="font-bold text-lg mb-2 text-main">Mes Notes sur ${surahNum}:${ayahNum}</h3>
                        <textarea id="note-textarea" class="w-full bg-white text-black border border-surface rounded-md p-2 h-48 resize-none">${noteText}</textarea>
                        <button id="save-note-btn" class="mt-2 w-full bg-primary text-bg-deep font-bold py-2 rounded-md hover:opacity-90">Sauvegarder</button>
                    `;
                    document.getElementById('save-note-btn').onclick = () => {
                        const text = document.getElementById('note-textarea').value;
                        if (text.trim()) state.notes[noteKey] = text; else delete state.notes[noteKey];
                        saveNotes();
                        showNotification('Note sauvegardée !');
                    };
                    break;
            }
        };

        const playCurrentAyah = async () => {
            if (!state.currentSurahData || !state.currentSurahData.audio.ayahs[state.currentAyah - 1]) return;
            try {
                const audioSrc = state.currentSurahData.audio.ayahs[state.currentAyah - 1].audio;
                if (dom.audio.src !== audioSrc) {
                    dom.audio.src = audioSrc;
                }
                await dom.audio.play();
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error("Error during audio playback:", error);
                    showNotification('Erreur de lecture audio.', 'error');
                }
            }
        };

        async function initializeApp() {
            applySettings();
            setupEventListeners();
            if (!state.settings.hasOnboarded) {
                renderOnboardingModal();
                state.settings.hasOnboarded = true;
                saveSettings();
            }
            showLoadingState(dom.surahList);
            showLoadingState(dom.ayahContainer);
            await loadInitialData();
            await getSurah(state.lastRead.surah, true);
            if (state.lastRead.ayah) {
                state.currentAyah = state.lastRead.ayah;
                highlightActiveAyah(state.currentAyah);
                renderContextPanel('tools', false);
            }
        }

        function setupEventListeners() {
            // Panneaux
            dom.menuBtn.onclick = () => dom.sidebar.classList.remove('-translate-x-full');
            dom.closeSidebarBtn.onclick = () => dom.sidebar.classList.add('-translate-x-full');
            dom.contextPanelBtn.onclick = () => dom.contextPanel.classList.remove('translate-x-full');
            dom.closeContextPanelBtn.onclick = () => dom.contextPanel.classList.add('translate-x-full');
            
            // Onglets
            dom.sidebar.querySelectorAll('.nav-tab').forEach(t => t.onclick = (e) => {
                dom.sidebar.querySelector('.nav-tab.active').classList.remove('active', 'bg-surface');
                e.currentTarget.classList.add('active', 'bg-surface');
                dom.sidebar.querySelector('.tab-content:not(.hidden)').classList.add('hidden');
                document.getElementById(`${e.currentTarget.dataset.tab}-tab`).classList.remove('hidden');
            });
            dom.contextPanel.querySelectorAll('.context-tab').forEach(t => t.onclick = (e) => {
                 dom.contextPanel.querySelector('.context-tab.active').classList.remove('active', 'bg-surface');
                 e.currentTarget.classList.add('active', 'bg-surface');
                 renderContextPanel(e.currentTarget.dataset.tab, true);
            });
            
            // Boutons
            dom.zenModeBtn.onclick = () => dom.app.classList.toggle('zen-mode');
            dom.surahSearch.oninput = (e) => renderSurahList(e.target.value);
            
            // Audio
            dom.audio.onplay = () => { dom.audioPlayPauseIcon.className = 'fas fa-pause'; dom.playSurahBtnIcon.className = 'fas fa-pause'; };
            dom.audio.onpause = () => { dom.audioPlayPauseIcon.className = 'fas fa-play'; dom.playSurahBtnIcon.className = 'fas fa-play'; };
            dom.audio.ontimeupdate = () => {
                dom.currentTimeElem.textContent = formatTime(dom.audio.currentTime);
                if (dom.audio.duration) dom.audioProgressBar.value = dom.audio.currentTime;
            };
            dom.audio.onloadedmetadata = () => {
                dom.durationElem.textContent = formatTime(dom.audio.duration);
                dom.audioProgressBar.max = dom.audio.duration;
            };
            dom.audio.onended = async () => {
                if(state.settings.repeat === 'ayah') { await playCurrentAyah(); }
                else if (state.currentAyah < state.currentSurahData.arabic.ayahs.length) { await handleAyahClick(state.currentAyah + 1); }
                else if (state.settings.repeat === 'surah') { await handleAyahClick(1); }
            };

            dom.audioPlayPause.onclick = () => dom.audio.paused ? playCurrentAyah() : dom.audio.pause();
            dom.playSurahBtn.onclick = () => {
                if (dom.audio.paused) {
                    if (dom.audio.currentTime > 0 && !dom.audio.ended) dom.audio.play(); else handleAyahClick(1);
                } else {
                    dom.audio.pause();
                }
            };
            dom.audioNext.onclick = async () => { if (state.currentAyah < state.currentSurahData.arabic.ayahs.length) await handleAyahClick(state.currentAyah + 1); };
            dom.audioPrev.onclick = async () => { if (state.currentAyah > 1) await handleAyahClick(state.currentAyah - 1); };
            dom.audioProgressBar.oninput = () => dom.audio.currentTime = dom.audioProgressBar.value;
            dom.ayahContainer.onclick = (e) => {
                const ayahEl = e.target.closest('.ayah');
                if(ayahEl) handleAyahClick(parseInt(ayahEl.dataset.ayahNumber));
            };
        }

        async function loadInitialData() {
            const surahData = await fetchAPI(`${QURAN_API_BASE}/surah`);
            if (surahData) { state.surahs = surahData.data; renderSurahList(); }
            renderJuzList();
        }

        initializeApp();
    });
    </script>
</body>
</html>

