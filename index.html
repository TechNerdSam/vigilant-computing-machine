<!DOCTYPE html>
<html lang="fr" class="theme-celestial">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OASIS-ULTIMA | Expérience Spirituelle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&family=Plus+Jakarta+Sans:wght@200;300;400;500;600;700;800&family=Playfair+Display:italic,wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --font-ui: 'Plus Jakarta Sans', sans-serif;
            --font-quran: 'Amiri Quran', serif;
            --font-serif: 'Playfair Display', serif;
            --ease-in-out-expo: cubic-bezier(0.19, 1, 0.22, 1);
            --transition-main: all 0.6s var(--ease-in-out-expo);
        }

        /* Thèmes 2.0 - Palettes Sophistiquées */
        html.theme-celestial {
            --accent: #a5b4fc; --accent-glow: rgba(165, 180, 252, 0.4);
            --bg-deep: #020617; --bg-glass: rgba(15, 23, 42, 0.6);
            --text-main: #f8fafc; --text-dim: #94a3b8; --border: rgba(255, 255, 255, 0.08);
            --gradient-nebula: radial-gradient(circle at 50% -20%, #1e1b4b 0%, #020617 80%);
        }
        html.theme-sahara {
            --accent: #fbbf24; --accent-glow: rgba(251, 191, 36, 0.3);
            --bg-deep: #0c0a09; --bg-glass: rgba(28, 25, 23, 0.75);
            --text-main: #fff7ed; --text-dim: #a8a29e; --border: rgba(251, 191, 36, 0.1);
            --gradient-nebula: radial-gradient(circle at 50% -20%, #451a03 0%, #0c0a09 80%);
        }
        html.theme-zen {
            --accent: #34d399; --accent-glow: rgba(52, 211, 153, 0.3);
            --bg-deep: #090909; --bg-glass: rgba(18, 18, 18, 0.8);
            --text-main: #f1f5f9; --text-dim: #475569; --border: rgba(255, 255, 255, 0.05);
            --gradient-nebula: radial-gradient(circle at 50% -20%, #064e3b 0%, #090909 80%);
        }

        body {
            font-family: var(--font-ui);
            background: var(--bg-deep);
            color: var(--text-main);
            transition: var(--transition-main);
            overflow-x: hidden;
            letter-spacing: -0.01em;
        }

        #bg-canvas {
            position: fixed; top: 0; left: 0; z-index: -1;
            width: 100%; height: 100%;
            background: var(--gradient-nebula);
        }

        /* Glassmorphism Advanced */
        .glass-ui {
            background: var(--bg-glass);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid var(--border);
        }

        .border-glow {
            position: relative;
        }
        .border-glow::after {
            content: ''; position: absolute; inset: -1px;
            background: linear-gradient(135deg, var(--accent), transparent, var(--accent));
            opacity: 0.1; border-radius: inherit; z-index: -1;
            transition: var(--transition-main);
        }
        .border-glow:hover::after { opacity: 0.4; }

        /* Bento Cards UI */
        .card-ayah {
            border-radius: 32px;
            transition: var(--transition-main);
            cursor: pointer;
        }
        .card-ayah:hover {
            transform: translateY(-8px) scale(1.02);
            background: rgba(255, 255, 255, 0.03);
        }
        .card-ayah.active {
            border-color: var(--accent);
            background: var(--accent-glow);
            box-shadow: 0 30px 60px -15px rgba(0,0,0,0.5);
        }

        /* Typography Styles */
        .quran-script {
            font-family: var(--font-quran);
            font-size: 3rem;
            line-height: 2.4;
            text-align: right;
            direction: rtl;
        }

        /* Nexus Player Floating */
        .nexus-pill {
            position: fixed;
            bottom: 2.5rem;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            max-width: 850px;
            z-index: 100;
            border-radius: 50px;
            box-shadow: 0 40px 80px -20px rgba(0,0,0,0.8);
        }

        /* Custom Elements */
        .nav-link {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            font-weight: 800;
            opacity: 0.4;
            transition: var(--transition-main);
        }
        .nav-link:hover, .nav-link.active { opacity: 1; color: var(--accent); }

        /* Transcendence Animation */
        .transcendence .hide-ui { opacity: 0; pointer-events: none; transform: translateY(-20px); }
        .transcendence .card-ayah:not(.active) { opacity: 0.05; filter: blur(10px); transform: scale(0.95); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; opacity: 0.2; }
    </style>
</head>
<body class="antialiased selection:bg-indigo-500/40">

    <canvas id="bg-canvas"></canvas>

    <!-- Header Flottant Ultra-Minimal -->
    <header class="fixed top-8 left-0 w-full px-8 z-50 hide-ui transition-all duration-700">
        <div class="max-w-screen-2xl mx-auto flex justify-between items-center">
            <div class="glass-ui px-6 py-3 rounded-full flex items-center gap-6">
                <button id="sidebar-open" class="text-xl hover:text-indigo-300 transition-colors">
                    <i class="fa-solid fa-align-left"></i>
                </button>
                <div class="h-4 w-[1px] bg-white/10"></div>
                <div class="flex flex-col">
                    <span class="text-[9px] font-black uppercase tracking-[0.4em] opacity-30">Oasis.System</span>
                    <span id="header-title" class="font-serif italic font-bold text-sm tracking-wide">Al-Fatihah</span>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="glass-ui h-12 flex items-center px-6 rounded-full hidden lg:flex gap-8">
                    <button class="nav-link active">Lecture</button>
                    <button class="nav-link">Audio</button>
                    <button class="nav-link">Histoire</button>
                </div>
                <button id="theme-btn" class="glass-ui w-12 h-12 flex items-center justify-center rounded-full hover:rotate-180 transition-transform duration-700">
                    <i class="fa-solid fa-circle-half-stroke"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Sidebar "Spatial" -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-[450px] z-[60] glass-ui rounded-r-[60px] -translate-x-full transition-all duration-1000 ease-[cubic-bezier(0.23,1,0.32,1)] p-12 overflow-y-auto no-scrollbar">
        <div class="flex flex-col h-full">
            <div class="flex justify-between items-center mb-16">
                <h2 class="font-serif italic text-4xl">Le Livre</h2>
                <button id="sidebar-close" class="w-12 h-12 rounded-full hover:bg-white/10 flex items-center justify-center transition-colors">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div class="relative mb-12">
                <i class="fa-solid fa-magnifying-glass absolute left-6 top-1/2 -translate-y-1/2 opacity-20"></i>
                <input type="text" id="surah-search" placeholder="Rechercher une sourate..." class="w-full bg-white/5 border border-white/10 rounded-3xl py-5 pl-14 pr-6 focus:outline-none focus:border-indigo-500/50 transition-all text-sm font-medium">
            </div>

            <nav id="surah-list" class="space-y-4 pr-4">
                <!-- Injected via JS -->
            </nav>

            <div class="mt-auto pt-10 grid grid-cols-2 gap-4">
                <div class="glass-ui p-6 rounded-[32px] group hover:bg-indigo-500/10 transition-colors cursor-pointer">
                    <p class="text-[10px] uppercase font-bold opacity-30 group-hover:opacity-100 mb-2 transition-opacity">Progression</p>
                    <p class="text-xl font-bold">14%</p>
                </div>
                <div class="glass-ui p-6 rounded-[32px] group hover:bg-emerald-500/10 transition-colors cursor-pointer">
                    <p class="text-[10px] uppercase font-bold opacity-30 group-hover:opacity-100 mb-2 transition-opacity">Hassanat</p>
                    <p class="text-xl font-bold">∞</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Rendering Engine -->
    <main class="relative pt-44 pb-60 px-6 md:px-16 lg:px-32 max-w-7xl mx-auto min-h-screen">
        
        <!-- Hero Section -->
        <section id="hero" class="mb-32 text-center hide-ui transition-all duration-1000">
            <div class="inline-block relative mb-12">
                <h1 id="surah-ar" class="quran-script text-8xl md:text-[10rem] opacity-90 leading-none"></h1>
                <div class="absolute -bottom-8 left-1/2 -translate-x-1/2 w-32 h-[1px] bg-gradient-to-r from-transparent via-indigo-500 to-transparent"></div>
            </div>
            <div class="flex flex-col items-center">
                <h2 id="surah-en" class="font-serif italic text-6xl md:text-8xl font-bold mb-6 tracking-tight"></h2>
                <div class="flex items-center gap-8 text-[11px] font-black uppercase tracking-[0.5em] opacity-40">
                    <span id="meta-type"></span>
                    <span class="w-2 h-2 rounded-full bg-indigo-500 shadow-[0_0_10px_var(--accent)]"></span>
                    <span id="meta-count"></span>
                </div>
            </div>
        </section>

        <!-- Verses List -->
        <section id="ayah-container" class="space-y-20">
            <!-- Injected -->
        </section>
    </main>

    <!-- NEXUS PLAYER PILL -->
    <div id="player" class="nexus-pill glass-ui p-6 border-white/20 transition-all duration-700 hover:scale-[1.01] hover:border-white/30">
        <div class="flex flex-col md:flex-row items-center gap-8">
            
            <div class="flex items-center gap-5 min-w-[220px]">
                <div class="w-14 h-14 rounded-2xl bg-indigo-500/20 flex items-center justify-center text-indigo-300 relative">
                    <i class="fa-solid fa-tower-broadcast text-xl"></i>
                    <div class="absolute -top-1 -right-1 w-3 h-3 bg-indigo-500 rounded-full animate-ping"></div>
                </div>
                <div>
                    <p id="player-title" class="text-sm font-bold tracking-tight">Chargement...</p>
                    <p id="player-sub" class="text-[10px] font-medium opacity-40 uppercase tracking-widest">Mishary Alafasy</p>
                </div>
            </div>

            <div class="flex-grow flex flex-col gap-3 w-full">
                <div class="flex items-center justify-between md:justify-center gap-12">
                    <button id="prev-btn" class="text-xl opacity-30 hover:opacity-100 hover:text-indigo-300 transition-all"><i class="fa-solid fa-chevron-left"></i></button>
                    <button id="play-btn" class="w-16 h-16 rounded-full bg-white text-black flex items-center justify-center hover:scale-110 shadow-xl transition-all active:scale-95">
                        <i class="fa-solid fa-play text-xl ml-1"></i>
                    </button>
                    <button id="next-btn" class="text-xl opacity-30 hover:opacity-100 hover:text-indigo-300 transition-all"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div class="relative w-full h-1 bg-white/5 rounded-full overflow-hidden cursor-pointer group" id="seek-bar">
                    <div id="progress" class="absolute inset-y-0 left-0 bg-gradient-to-r from-indigo-500 via-purple-400 to-cyan-400 w-0 transition-all duration-300"></div>
                </div>
            </div>

            <div class="flex items-center gap-5">
                <button id="transcendence-btn" class="w-11 h-11 rounded-full glass-ui flex items-center justify-center hover:bg-white/10 transition-all" title="Mode Transcendence">
                    <i class="fa-solid fa-moon"></i>
                </button>
                <div class="h-8 w-[1px] bg-white/10"></div>
                <button id="speed-btn" class="text-[10px] font-black glass-ui px-4 py-2 rounded-xl hover:bg-white/10 transition-all">1.0X</button>
            </div>
        </div>
    </div>

    <!-- Notification Engine -->
    <div id="notif-box" class="fixed top-32 right-10 z-[100] flex flex-col gap-4"></div>

    <script>
        const state = {
            surahs: [],
            current: null,
            activeIdx: 0,
            isPlaying: false,
            isZen: false,
            settings: { theme: 'theme-celestial', lang: 'fr.hamidullah', qari: 'ar.alafasy' }
        };

        const API = "https://api.alquran.cloud/v1";
        const audio = new Audio();

        // -- Particle Engine (Stars) --
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let stars = [];

        function initStars() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            stars = [];
            for(let i=0; i<150; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    z: Math.random() * 2,
                    ov: Math.random() * 0.5
                });
            }
        }

        function drawStars() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            const color = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
            ctx.fillStyle = color;
            stars.forEach(s => {
                ctx.globalAlpha = s.ov;
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.z, 0, Math.PI*2);
                ctx.fill();
                s.y -= 0.1;
                if(s.y < 0) s.y = canvas.height;
            });
            requestAnimationFrame(drawStars);
        }

        // -- Data Fetching --
        async function init() {
            initStars();
            drawStars();
            try {
                const res = await fetch(`${API}/surah`);
                const data = await res.json();
                state.surahs = data.data;
                renderSidebar();
                await loadSurah(1); // Fatihah initial
            } catch (err) {
                notify("Connexion impossible", "error");
            }
            setupEvents();
        }

        async function loadSurah(id) {
            document.getElementById('ayah-container').innerHTML = `<div class="py-40 text-center animate-pulse"><i class="fa-solid fa-bahai fa-spin text-7xl text-indigo-400"></i></div>`;
            try {
                const [ar, tr, au] = await Promise.all([
                    fetch(`${API}/surah/${id}`).then(r=>r.json()),
                    fetch(`${API}/surah/${id}/${state.settings.lang}`).then(r=>r.json()),
                    fetch(`${API}/surah/${id}/${state.settings.qari}`).then(r=>r.json())
                ]);
                state.current = { ar: ar.data, tr: tr.data, au: au.data };
                renderContent();
                document.getElementById('header-title').textContent = ar.data.englishName;
                document.getElementById('player-title').textContent = ar.data.englishName;
                notify(`Sourate ${ar.data.englishName} prête`);
                window.scrollTo({top:0, behavior:'smooth'});
            } catch (e) { notify("Erreur de chargement", "error"); }
        }

        function renderContent() {
            const s = state.current;
            document.getElementById('surah-ar').textContent = s.ar.name;
            document.getElementById('surah-en').textContent = s.ar.englishName;
            document.getElementById('meta-type').textContent = s.ar.revelationType === 'Meccan' ? 'Mecquoise' : 'Médinoise';
            document.getElementById('meta-count').textContent = `${s.ar.numberOfAyahs} Versets`;

            document.getElementById('ayah-container').innerHTML = s.ar.ayahs.map((ayah, i) => `
                <div id="ayah-${i}" class="card-ayah glass-ui p-10 md:p-16 border-glow group" onclick="playAyah(${i})">
                    <div class="flex justify-between items-center mb-10 opacity-30 group-hover:opacity-100 transition-opacity">
                        <span class="text-[10px] font-black tracking-widest px-4 py-2 border border-white/10 rounded-full">AYAH ${ayah.numberInSurah}</span>
                        <div class="flex gap-6">
                            <i class="fa-regular fa-heart hover:text-red-400 cursor-pointer transition-colors"></i>
                            <i class="fa-solid fa-share-nodes hover:text-indigo-400 cursor-pointer transition-colors"></i>
                        </div>
                    </div>
                    <p class="quran-script mb-10 group-hover:text-indigo-200 transition-colors">${ayah.text}</p>
                    <div class="h-[1px] w-1/4 bg-white/10 mb-10 transition-all group-hover:w-full"></div>
                    <p class="text-2xl md:text-3xl font-serif italic text-dim leading-relaxed group-hover:text-white transition-colors">
                        ${s.tr.ayahs[i].text}
                    </p>
                </div>
            `).join('');
        }

        function renderSidebar(query = "") {
            const list = document.getElementById('surah-list');
            list.innerHTML = state.surahs
                .filter(s => s.englishName.toLowerCase().includes(query.toLowerCase()))
                .map(s => `
                    <div class="flex items-center justify-between p-5 rounded-[24px] hover:bg-white/5 cursor-pointer border border-transparent hover:border-white/10 transition-all group" onclick="loadSurah(${s.number})">
                        <div class="flex items-center gap-5">
                            <span class="text-[10px] font-black opacity-20 group-hover:opacity-100">${s.number}</span>
                            <div>
                                <p class="text-sm font-bold group-hover:text-indigo-300 transition-colors">${s.englishName}</p>
                                <p class="text-[9px] uppercase opacity-40 font-bold">${s.revelationType}</p>
                            </div>
                        </div>
                        <span class="quran-script text-xl opacity-20 group-hover:opacity-100 transition-opacity">${s.name.replace('سُورَةُ ', '')}</span>
                    </div>
                `).join('');
        }

        // -- Playback Engine --
        async function playAyah(idx) {
            state.activeIdx = idx;
            const src = state.current.au.ayahs[idx].audio;
            
            try {
                // Gestion asynchrone pour éviter l'AbortError si play() est appelé rapidement
                if (audio.src !== src) {
                    audio.pause();
                    audio.src = src;
                    audio.load();
                }

                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    await playPromise;
                }
                
                state.isPlaying = true;
                updateUI();
            } catch (error) {
                // On ignore l'AbortError car il s'agit d'une interruption normale 
                // lors d'un changement rapide de verset
                if (error.name !== 'AbortError') {
                    console.error("Erreur de lecture audio :", error);
                    notify("Erreur de lecture", "error");
                }
            }
        }

        function updateUI() {
            const btn = document.getElementById('play-btn');
            btn.innerHTML = state.isPlaying ? '<i class="fa-solid fa-pause text-xl"></i>' : '<i class="fa-solid fa-play text-xl ml-1"></i>';
            
            document.querySelectorAll('.card-ayah').forEach(c => c.classList.remove('active'));
            const active = document.getElementById(`ayah-${state.activeIdx}`);
            if(active) {
                active.classList.add('active');
                if(!state.isZen) active.scrollIntoView({behavior:'smooth', block:'center'});
            }
        }

        audio.onended = () => {
            if(state.activeIdx < state.current.ar.ayahs.length - 1) playAyah(state.activeIdx + 1);
            else { state.isPlaying = false; updateUI(); }
        };

        audio.ontimeupdate = () => {
            if (audio.duration) {
                const p = (audio.currentTime / audio.duration) * 100;
                document.getElementById('progress').style.width = `${p}%`;
            }
        };

        // -- Global Events --
        function setupEvents() {
            document.getElementById('sidebar-open').onclick = () => document.getElementById('sidebar').classList.remove('-translate-x-full');
            document.getElementById('sidebar-close').onclick = () => document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('surah-search').oninput = (e) => renderSidebar(e.target.value);
            
            document.getElementById('play-btn').onclick = () => {
                if (state.isPlaying) {
                    audio.pause();
                    state.isPlaying = false;
                } else {
                    // Utilise playAyah pour relancer proprement la lecture
                    playAyah(state.activeIdx);
                }
                updateUI();
            };

            document.getElementById('transcendence-btn').onclick = () => {
                state.isZen = !state.isZen;
                document.body.classList.toggle('transcendence', state.isZen);
                document.getElementById('transcendence-btn').classList.toggle('bg-indigo-500', state.isZen);
                notify(state.isZen ? "Immersion Totale Activée" : "Mode Standard", "info");
            };

            document.getElementById('theme-btn').onclick = () => {
                const themes = ['theme-celestial', 'theme-sahara', 'theme-zen'];
                state.settings.theme = themes[(themes.indexOf(state.settings.theme) + 1) % themes.length];
                document.documentElement.className = state.settings.theme;
                notify(`Ambiance ${state.settings.theme.split('-')[1]} sélectionnée`);
            };

            window.addEventListener('resize', initStars);
        }

        function notify(msg, type = 'success') {
            const box = document.getElementById('notif-box');
            const n = document.createElement('div');
            n.className = `glass-ui px-8 py-5 rounded-[24px] flex items-center gap-4 transition-all duration-700 translate-x-20 opacity-0 border-l-4 ${type==='success'?'border-indigo-400':'border-red-400'}`;
            n.innerHTML = `<i class="fa-solid ${type==='success'?'fa-circle-check text-indigo-400':'fa-triangle-exclamation text-red-400'}"></i> <span class="text-xs font-black tracking-widest uppercase">${msg}</span>`;
            box.appendChild(n);
            setTimeout(() => n.classList.remove('translate-x-20', 'opacity-0'), 10);
            setTimeout(() => { n.classList.add('translate-x-20', 'opacity-0'); setTimeout(()=>n.remove(), 700); }, 3500);
        }

        window.onload = init;
    </script>
</body>
</html>
